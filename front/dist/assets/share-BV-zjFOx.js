import{a as M,r as w,z as X,C as D,c as A,b as i,u,t as h,A as z,n as U,F as J,e as Y,y as Z,J as V,G as I,o as p,D as q,S as Q,O as H,U as ee,V as te}from"./basic-gG3E2qrt.js";const se="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAAXFJREFUeJzt3MFtwkAUQEEcXAv9JJekGU40k1MKopYgp4LYSMZMAm+ulvBKT1/ywpph//o+7awB339T31+fs9df7rSO/KIAWAGwAmAFwAqAFQAb9D7gcjws7QP0PmVTTQBWAKwAWAGwAmAFwAqAjTf4jIf+Pn9rTQBWAKwAWAGwAmAFwAqA3WIf8Net2qfsT+dVN78cD7PXmwCsAFgBsAJgBcAKgBUAG684l6Pp9a09lzS7/iYAKwBWAKwAWAGwAmAFwBZ/D9ifzg99Pl9rArACYAXACoAVACsAVgCsAFgBsAJgBcAKgBUAKwBWAGzz9wP+wbkjqgnACoAVACsAVgCsAFgBsGv2Afo5ftPz+WvfA96tXF8TgBUAKwBWAKwAWAGwAmDjbuE5dun/brJOE4AVACsAVgCsAFgBsAJgz/C/oUvoe9BNAFYArABYAbACYAXACoAN0zT/GDy+fdxpKUz7gGdWAKwAWAGwAmAFwAqA/QBKwB5hvZLOAgAAAABJRU5ErkJggg==",ne={class:"sh_fr_header"},oe={class:"operator"},ae={class:"sh_fr_body"},re=["id","value"],le=["for"],ie=["onClick"],ce={key:0},ue=["onClick"],de=["onClick"],Ae={class:"sh_fr_footer"},pe=M({__name:"share",setup(fe){let f=0,y=w([]),k=w(null),b=w(null),d=w([]),c=[],m=0,_=0,C=0,g=0,L=w(""),S=w("");X(async()=>{const s=new URL(location.href);P(s)});async function P(s){f=s.searchParams.get("id");let t=s.searchParams.get("node");d.value=[];const e=await W(f,t);y.value=e.node,b.value=e.parent,k.value=e.cur}async function v(s){if(s.type==="directory")T(f,s.id);else{if(!s.file_index.raw)return;await B("single",s)}}async function B(s,t){var a,r;switch(c=[],m=0,_=0,C=0,g=0,s){case"list":d.value.forEach(o=>{y.value.forEach(n=>{n.id===o&&c.push(n)})});break;case"total":y.value.forEach(o=>{c.push(o)});break;case"single":c.push(t);break}for(let o=0;o<c.length;o++){if(c[o].type!=="directory")continue;(await E(c[o])).forEach(l=>c.push(l))}c.forEach(o=>{var n,l;(l=(n=o.file_index)==null?void 0:n.raw)!=null&&l.size&&(_+=1,g+=o.file_index.raw.size)});const e=new Map;for(let o=0;o<c.length;o++){const n=c[o],l={id:n.id,pid:n.id_parent,title:n.title,type:n.type,path:n.title};c[o].type!=="directory"&&(r=(a=c[o].file_index)==null?void 0:a.raw)!=null&&r.size&&(l.buffer=await O(c[o])),e.set(n.id,l)}if(c.length===1){const o=e.get(c[0].id);if(o){const n=o.buffer;n&&G(c[0].title,n)}}else{const o=new V;e.forEach((n,l,we)=>{n.path=x(n,e),n.type==="directory"?o.folder(n.path):o.file(n.path,n.buffer)}),o.generateAsync({type:"blob"}).then(n=>{let l=document.createElement("a");l.style.display="none",l.href=URL.createObjectURL(n),l.target="_blank",l.setAttribute("download",`share.${new Date().toISOString().replace(/[-:\s]/,"")}.zip`),l.click()})}}async function E(s){const t=[],a=(await W(f,s.id)).node;for(let r=0;r<a.length;r++)t.push(a[r]),a[r].type==="directory"&&(await E(a[r])).forEach(n=>t.push(n));return t}function x(s,t){const e=[s.title],a=[s.pid];for(;;){let r=!1;if(t.forEach(o=>{o.id===a[0]&&(r=!0,e.unshift(o.title),a.unshift(o.pid))}),!a[0]||!r)break}return e.join("/")}function G(s,t){const e=new Blob([t],{type:"application/octet-stream"});let a=document.createElement("a");a.style.display="none",a.href=URL.createObjectURL(e),a.target="_blank",a.setAttribute("download",s),a.click()}async function O(s){const t=new FormData;t.append("id",f),t.append("id_node",s.id);const e=await K(D.apiPath+"share/get",t,N);return m+=1,C+=s.file_index.raw.size,F(),e}function K(s,t,e){return new Promise(a=>{const r=new XMLHttpRequest;r.withCredentials=!0,r.responseType="arraybuffer",r.onreadystatechange=function(){if(r.readyState===4){if(r.status>=400)return R(`${r.status}:${r.statusText}`);a(r.response)}},r.onprogress=e,r.open("POST",s),r.send(t)})}function N(s){F(s)}function F(s){let t=C+(s?s.loaded:0),e=t/g;e*=1e4,e=Math.round(e),e/=100,e+="%",L.value=`${m}/${_} files, ${e}, ${I.kmgt(t)} / ${I.kmgt(g)}`,S.value=`width: ${e};`}function T(s,t){const e=new URL(location.href);e.searchParams.set("id",s),t?e.searchParams.set("node",t):e.searchParams.delete("node"),history.pushState(null,null,e),P(e)}addEventListener("popstate",s=>{P(new URL(location.href))});async function W(s,t){return await $("share/node_list",{id:s,id_node:t})}function $(s,t,e){return new Promise((a,r)=>{let o;if(t instanceof FormData)o=t;else{o=new FormData;for(const l in t)Object.prototype.hasOwnProperty.call(t,l)&&o.append(l,t[l])}const n=new XMLHttpRequest;n.withCredentials=!0,n.onreadystatechange=function(){if(n.readyState!==4)return;if(n.status>=400)return R(`${n.status}:${n.statusText}`);const l=JSON.parse(n.responseText);l.code&&R(l.msg),a(l.data)},n.open("POST",D.apiPath+s),n.send(o)})}function R(s){throw alert(s),new Error(s)}return(s,t)=>(p(),A(J,null,[i("div",ne,[t[4]||(t[4]=i("div",null,[i("img",{src:se}),i("span",null,"MyNas Share")],-1)),i("div",oe,[u(d).length?(p(),A("span",{key:0,class:"pointer sysIcon sysIcon_download",onClick:t[0]||(t[0]=e=>B("list"))},"Download "+h(u(d).length)+" selected file/folders",1)):z("",!0),i("span",{class:"pointer sysIcon sysIcon_download",onClick:t[1]||(t[1]=e=>B("total"))},"Download All")])]),i("div",ae,[i("ul",null,[u(k)&&u(k).id?(p(),A("li",{key:0,class:"pointer",onClick:t[2]||(t[2]=e=>T(u(f),u(b)?u(b).id:0))},t[5]||(t[5]=[i("p",null,[i("span",{class:U(["thumb","listIcon","listIcon_file_directory"])}),i("span",null,"../")],-1)]))):z("",!0),(p(!0),A(J,null,Y(u(y),e=>(p(),A("li",{key:e.id},[i("p",null,[q(i("input",{type:"checkbox",name:"selector",id:`selector_${e.id}`,value:e.id,"onUpdate:modelValue":t[3]||(t[3]=a=>H(d)?d.value=a:d=a)},null,8,re),[[Q,u(d)]]),i("label",{for:`selector_${e.id}`,class:"pointer"},null,8,le),i("span",{class:U(["thumb","listIcon",`listIcon_file_${e.type}`])},null,2),i("span",{class:"pointer",onClick:a=>v(e)},h(e.title),9,ie)]),i("p",null,[e.type!=="directory"?(p(),A("span",ce,h(u(I).kmgt(e.file_index.raw.size)),1)):z("",!0),i("span",null,h(e.time_update),1),e.type==="directory"?(p(),A("span",{key:1,class:"pointer sysIcon sysIcon_folder",onClick:a=>v(e)},null,8,ue)):(p(),A("span",{key:2,class:"pointer sysIcon sysIcon_download",onClick:a=>v(e)},null,8,de))])]))),128))])]),i("div",Ae,[i("div",{class:"process",style:Z(u(S))},h(u(L)),5)])],64))}}),j=ee(pe);j.use(te());j.mount("#app");
