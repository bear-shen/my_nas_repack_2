import{a as X,r as A,z as Y,C as D,c as u,b as i,t as h,A as I,u as U,n as J,F as j,e as Z,y as V,J as q,G as R,o as d,D as Q,S as H,U as ee,V as te}from"./basic-DfhHe1pL.js";const se="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAAXFJREFUeJzt3MFtwkAUQEEcXAv9JJekGU40k1MKopYgp4LYSMZMAm+ulvBKT1/ywpph//o+7awB339T31+fs9df7rSO/KIAWAGwAmAFwAqAFQAb9D7gcjws7QP0PmVTTQBWAKwAWAGwAmAFwAqAjTf4jIf+Pn9rTQBWAKwAWAGwAmAFwAqA3WIf8Net2qfsT+dVN78cD7PXmwCsAFgBsAJgBcAKgBUAG684l6Pp9a09lzS7/iYAKwBWAKwAWAGwAmAFwBZ/D9ifzg99Pl9rArACYAXACoAVACsAVgCsAFgBsAJgBcAKgBUAKwBWAGzz9wP+wbkjqgnACoAVACsAVgCsAFgBsGv2Afo5ftPz+WvfA96tXF8TgBUAKwBWAKwAWAGwAmDjbuE5dun/brJOE4AVACsAVgCsAFgBsAJgz/C/oUvoe9BNAFYArABYAbACYAXACoAN0zT/GDy+fdxpKUz7gGdWAKwAWAGwAmAFwAqA/QBKwB5hvZLOAgAAAABJRU5ErkJggg==",ne={class:"sh_fr_header"},oe={class:"operator"},ae={class:"sh_fr_body"},re={key:0,class:"err_msg"},le={key:1},ie=["id","value"],ce=["for"],ue=["onClick"],de={key:0},Ae=["onClick"],pe=["onClick"],fe={class:"sh_fr_footer"},he=X({__name:"share",setup(we){const g=A("");let p=0;const w=A([]),k=A(null),_=A(null),f=A([]);let c=[],v=0,b=0,m=50,y=100;const L=A(""),S=A("");Y(async()=>{const s=new URL(location.href);C(s)});async function C(s){p=s.searchParams.get("id");let t=s.searchParams.get("node");f.value=[];const e=await W(p,t);w.value=e.node,_.value=e.parent,k.value=e.cur}async function P(s){if(s.type==="directory")T(p,s.id);else{if(!s.file_index.raw)return;await B("single",s)}}async function B(s,t){var a,r;switch(c=[],v=0,b=0,m=0,y=0,s){case"list":f.value.forEach(o=>{w.value.forEach(n=>{n.id===o&&c.push(n)})});break;case"total":w.value.forEach(o=>{c.push(o)});break;case"single":c.push(t);break}for(let o=0;o<c.length;o++){if(c[o].type!=="directory")continue;(await E(c[o])).forEach(l=>c.push(l))}c.forEach(o=>{var n,l;(l=(n=o.file_index)==null?void 0:n.raw)!=null&&l.size&&(b+=1,y+=o.file_index.raw.size)});const e=new Map;for(let o=0;o<c.length;o++){const n=c[o],l={id:n.id,pid:n.id_parent,title:n.title,type:n.type,path:n.title};c[o].type!=="directory"&&(r=(a=c[o].file_index)==null?void 0:a.raw)!=null&&r.size&&(l.buffer=await $(c[o])),e.set(n.id,l)}if(c.length===1){const o=e.get(c[0].id);if(o){const n=o.buffer;n&&O(c[0].title,n)}}else{const o=new q;e.forEach((n,l,ye)=>{n.path=G(n,e),n.type==="directory"?o.folder(n.path):o.file(n.path,n.buffer)}),o.generateAsync({type:"blob"}).then(n=>{let l=document.createElement("a");l.style.display="none",l.href=URL.createObjectURL(n),l.target="_blank",l.setAttribute("download",`share.${new Date().toISOString().replace(/[-:\s]/,"")}.zip`),l.click()})}}async function E(s){const t=[],a=(await W(p,s.id)).node;for(let r=0;r<a.length;r++)t.push(a[r]),a[r].type==="directory"&&(await E(a[r])).forEach(n=>t.push(n));return t}function G(s,t){const e=[s.title],a=[s.pid];for(;;){let r=!1;if(t.forEach(o=>{o.id===a[0]&&(r=!0,e.unshift(o.title),a.unshift(o.pid))}),!a[0]||!r)break}return e.join("/")}function O(s,t){const e=new Blob([t],{type:"application/octet-stream"});let a=document.createElement("a");a.style.display="none",a.href=URL.createObjectURL(e),a.target="_blank",a.setAttribute("download",s),a.click()}async function $(s){const t=new FormData;t.append("id",p),t.append("id_node",s.id);const e=await K(D.apiPath+"share/get",t,M);return v+=1,m+=s.file_index.raw.size,F(),e}function K(s,t,e){return new Promise(a=>{const r=new XMLHttpRequest;r.withCredentials=!0,r.responseType="arraybuffer",r.onreadystatechange=function(){if(r.readyState===4){if(r.status>=400)return z(`${r.status}:${r.statusText}`);a(r.response)}},r.onprogress=e,r.open("POST",s),r.send(t)})}function M(s){F(s)}function F(s){let t=m+(s?s.loaded:0),e=t/y;e*=1e4,e=Math.round(e),e/=100,e+="%",L.value=`${v}/${b} Files, ${e}, ${R.kmgt(t)} / ${R.kmgt(y)}`,S.value=`width: ${e};`}function T(s,t){const e=new URL(location.href);e.searchParams.set("id",s),t?e.searchParams.set("node",t):e.searchParams.delete("node"),history.pushState(null,null,e),C(e)}addEventListener("popstate",s=>{C(new URL(location.href))});async function W(s,t){return await N("share/node_list",{id:s,id_node:t})}function N(s,t,e){return new Promise((a,r)=>{let o;if(t instanceof FormData)o=t;else{o=new FormData;for(const l in t)Object.prototype.hasOwnProperty.call(t,l)&&o.append(l,t[l])}const n=new XMLHttpRequest;n.withCredentials=!0,n.onreadystatechange=function(){if(n.readyState!==4)return;if(n.status>=400)return z(`${n.status}:${n.statusText}`);const l=JSON.parse(n.responseText);l.code&&z(l.msg),a(l.data)},n.open("POST",D.apiPath+s),n.send(o)})}function z(s){throw g.value=s,new Error(s)}return(s,t)=>(d(),u(j,null,[i("div",ne,[t[4]||(t[4]=i("div",null,[i("img",{src:se}),i("span",null,"MyNas Share")],-1)),i("div",oe,[f.value.length?(d(),u("span",{key:0,class:"pointer sysIcon sysIcon_download",onClick:t[0]||(t[0]=e=>B("list"))},"Download "+h(f.value.length)+" selected file/folders",1)):I("",!0),i("span",{class:"pointer sysIcon sysIcon_download",onClick:t[1]||(t[1]=e=>B("total"))},"Download All")])]),i("div",ae,[g.value.length?(d(),u("p",re,h(g.value),1)):(d(),u("ul",le,[k.value&&k.value.id?(d(),u("li",{key:0,class:"pointer",onClick:t[2]||(t[2]=e=>T(U(p),_.value?_.value.id:0))},t[5]||(t[5]=[i("p",null,[i("span",{class:J(["thumb","listIcon","listIcon_file_directory"])}),i("span",null,"../")],-1)]))):I("",!0),(d(!0),u(j,null,Z(w.value,e=>(d(),u("li",{key:e.id},[i("p",null,[Q(i("input",{type:"checkbox",name:"selector",id:`selector_${e.id}`,value:e.id,"onUpdate:modelValue":t[3]||(t[3]=a=>f.value=a)},null,8,ie),[[H,f.value]]),i("label",{for:`selector_${e.id}`,class:"pointer"},null,8,ce),i("span",{class:J(["thumb","listIcon",`listIcon_file_${e.type}`])},null,2),i("span",{class:"pointer",onClick:a=>P(e)},h(e.title),9,ue)]),i("p",null,[e.type!=="directory"?(d(),u("span",de,h(U(R).kmgt(e.file_index.raw.size)),1)):I("",!0),i("span",null,h(e.time_update),1),e.type==="directory"?(d(),u("span",{key:1,class:"pointer sysIcon sysIcon_folder",onClick:a=>P(e)},null,8,Ae)):(d(),u("span",{key:2,class:"pointer sysIcon sysIcon_download",onClick:a=>P(e)},null,8,pe))])]))),128))]))]),i("div",fe,[i("div",{class:"process",style:V(S.value)},h(L.value),5)])],64))}}),x=ee(he);x.use(te());x.mount("#app");
