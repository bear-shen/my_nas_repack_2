import{a as Q,r as A,z as Z,C as N,c as u,b as i,t as h,A as I,u as D,n as U,F as X,e as W,y as q,J as G,G as Y,o as d,D as H,S as K,U as ee,V as te}from"./basic-DfhHe1pL.js";const se="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAAURJREFUeJzt3IsNgjAUQFE1rMiSMKRuoCRVTwP3LECTm5dQPr1v2/a8WXd8feqhF3B1BcAKgBUAKwBWAKwA2KIX8Mm6rnqf8lNNAFYArABYAbACYAXACoB9Yx9w6ef5o5oArABYAbACYAXACoAVAJv+fcCofd+n3qc0AVgBsAJgBcAKgBUAKwC23CZ/nj/Bffzod0lv198EYAXACoAVACsAVgCsANiR9wGn/j5fawKwAmAFwAqAFQArAFYArABYAbACYAXACoAVACsAVgDsH/8H6O96ptYEYAXACoAVACsAVgCsANiRfQC9jx89N/QP/xcMra8JwAqAFQArAFYArABYAbDl7Ofzz64JwAqAFQArAFYArABYAbDTnxt6AN0HNQFYAbACYAXACoAVACsAtkxwLuelNQFYAbACYAXACoAVACsA9gLwGRXVwgM2xQAAAABJRU5ErkJggg==",ne={class:"sh_fr_header"},oe={class:"operator"},ae={class:"sh_fr_body"},re={key:0,class:"err_msg"},le={key:1},ie=["id","value"],ce=["for"],ue=["onClick"],de={key:0},Ae=["onClick"],pe=["onClick"],fe={class:"sh_fr_footer"},he=Q({__name:"share",setup(ye){const g=A("");let p=0;const y=A([]),_=A(null),b=A(null),f=A([]);let c=[],C=0,k=0,v=50,w=100;const S=A(""),z=A("");Z(async()=>{const s=new URL(location.href);m(s)});async function m(s){p=s.searchParams.get("id");let t=s.searchParams.get("node");f.value=[];const e=await F(p,t);y.value=e.node,b.value=e.parent,_.value=e.cur}async function R(s){if(s.type==="directory")E(p,s.id);else{if(!s.file_index.raw)return;await P("single",s)}}async function P(s,t){var a,r;switch(c=[],C=0,k=0,v=0,w=0,s){case"list":f.value.forEach(o=>{y.value.forEach(n=>{n.id===o&&c.push(n)})});break;case"total":y.value.forEach(o=>{c.push(o)});break;case"single":c.push(t);break}for(let o=0;o<c.length;o++){if(c[o].type!=="directory")continue;(await B(c[o])).forEach(l=>c.push(l))}c.forEach(o=>{var n,l;(l=(n=o.file_index)==null?void 0:n.raw)!=null&&l.size&&(k+=1,w+=o.file_index.raw.size)});const e=new Map;for(let o=0;o<c.length;o++){const n=c[o],l={id:n.id,pid:n.id_parent,title:n.title,type:n.type,path:n.title};c[o].type!=="directory"&&(r=(a=c[o].file_index)==null?void 0:a.raw)!=null&&r.size&&(l.buffer=await T(c[o])),e.set(n.id,l)}if(c.length===1){const o=e.get(c[0].id);if(o){const n=o.buffer;n&&M(c[0].title,n)}}else{const o=new G;e.forEach((n,l,we)=>{n.path=J(n,e),n.type==="directory"?o.folder(n.path):o.file(n.path,n.buffer)}),o.generateAsync({type:"blob"}).then(n=>{let l=document.createElement("a");l.style.display="none",l.href=URL.createObjectURL(n),l.target="_blank",l.setAttribute("download",`share.${new Date().toISOString().replace(/[-:\s]/,"")}.zip`),l.click()})}}async function B(s){const t=[],a=(await F(p,s.id)).node;for(let r=0;r<a.length;r++)t.push(a[r]),a[r].type==="directory"&&(await B(a[r])).forEach(n=>t.push(n));return t}function J(s,t){const e=[s.title],a=[s.pid];for(;;){let r=!1;if(t.forEach(o=>{o.id===a[0]&&(r=!0,e.unshift(o.title),a.unshift(o.pid))}),!a[0]||!r)break}return e.join("/")}function M(s,t){const e=new Blob([t],{type:"application/octet-stream"});let a=document.createElement("a");a.style.display="none",a.href=URL.createObjectURL(e),a.target="_blank",a.setAttribute("download",s),a.click()}async function T(s){const t=new FormData;t.append("id",p),t.append("id_node",s.id);const e=await V(N.apiPath+"share/get",t,$);return C+=1,v+=s.file_index.raw.size,x(),e}function V(s,t,e){return new Promise(a=>{const r=new XMLHttpRequest;r.withCredentials=!0,r.responseType="arraybuffer",r.onreadystatechange=function(){if(r.readyState===4){if(r.status>=400)return L(`${r.status}:${r.statusText}`);a(r.response)}},r.onprogress=e,r.open("POST",s),r.send(t)})}function $(s){x(s)}function x(s){let t=v+(s?s.loaded:0),e=t/w;e*=1e4,e=Math.round(e),e/=100,e+="%",S.value=`${C}/${k} Files, ${e}, ${Y.kmgt(t)} / ${Y.kmgt(w)}`,z.value=`width: ${e};`}function E(s,t){const e=new URL(location.href);e.searchParams.set("id",s),t?e.searchParams.set("node",t):e.searchParams.delete("node"),history.pushState(null,null,e),m(e)}addEventListener("popstate",s=>{m(new URL(location.href))});async function F(s,t){return await O("share/node_list",{id:s,id_node:t})}function O(s,t,e){return new Promise((a,r)=>{let o;if(t instanceof FormData)o=t;else{o=new FormData;for(const l in t)Object.prototype.hasOwnProperty.call(t,l)&&o.append(l,t[l])}const n=new XMLHttpRequest;n.withCredentials=!0,n.onreadystatechange=function(){if(n.readyState!==4)return;if(n.status>=400)return L(`${n.status}:${n.statusText}`);const l=JSON.parse(n.responseText);l.code&&L(l.msg),a(l.data)},n.open("POST",N.apiPath+s),n.send(o)})}function L(s){throw g.value=s,new Error(s)}return(s,t)=>(d(),u(X,null,[i("div",ne,[t[4]||(t[4]=i("div",null,[i("img",{src:se}),i("span",null,"MyNas Share")],-1)),i("div",oe,[f.value.length?(d(),u("span",{key:0,class:"pointer sysIcon sysIcon_download",onClick:t[0]||(t[0]=e=>P("list"))},"Download "+h(f.value.length)+" selected file/folders",1)):I("",!0),i("span",{class:"pointer sysIcon sysIcon_download",onClick:t[1]||(t[1]=e=>P("total"))},"Download All")])]),i("div",ae,[g.value.length?(d(),u("p",re,h(g.value),1)):(d(),u("ul",le,[_.value&&_.value.id?(d(),u("li",{key:0,class:"pointer",onClick:t[2]||(t[2]=e=>E(D(p),b.value?b.value.id:0))},t[5]||(t[5]=[i("p",null,[i("span",{class:U(["thumb","listIcon","listIcon_file_directory"])}),i("span",null,"../")],-1)]))):I("",!0),(d(!0),u(X,null,W(y.value,e=>(d(),u("li",{key:e.id},[i("p",null,[H(i("input",{type:"checkbox",name:"selector",id:`selector_${e.id}`,value:e.id,"onUpdate:modelValue":t[3]||(t[3]=a=>f.value=a)},null,8,ie),[[K,f.value]]),i("label",{for:`selector_${e.id}`,class:"pointer"},null,8,ce),i("span",{class:U(["thumb","listIcon",`listIcon_file_${e.type}`])},null,2),i("span",{class:"pointer",onClick:a=>R(e)},h(e.title),9,ue)]),i("p",null,[e.type!=="directory"?(d(),u("span",de,h(D(Y).kmgt(e.file_index.raw.size)),1)):I("",!0),i("span",null,h(e.time_update),1),e.type==="directory"?(d(),u("span",{key:1,class:"pointer sysIcon sysIcon_folder",onClick:a=>R(e)},null,8,Ae)):(d(),u("span",{key:2,class:"pointer sysIcon sysIcon_download",onClick:a=>R(e)},null,8,pe))])]))),128))]))]),i("div",fe,[i("div",{class:"process",style:q(z.value)},h(S.value),5)])],64))}}),j=ee(he);j.use(te());j.mount("#app");
